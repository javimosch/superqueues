version: '3.8'

# Production-like cluster setup:
# - 3 RabbitMQ nodes (clustered)
# - HAProxy for AMQP + Management API load balancing
# - 3 Gateway instances
# - Nginx for Gateway HTTP load balancing
# - Shared MongoDB + Redis
#
# Usage:
#   docker compose -f docker-compose.cluster.yml up -d
#   # Then run cluster init:
#   ./cluster/scripts/init-cluster.sh

x-rabbitmq-common: &rabbitmq-common
  image: rabbitmq:3-management
  environment:
    RABBITMQ_ERLANG_COOKIE: "superqueues-cluster-cookie"
    RABBITMQ_DEFAULT_USER: guest
    RABBITMQ_DEFAULT_PASS: guest
  healthcheck:
    test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
    interval: 10s
    timeout: 5s
    retries: 5

x-gateway-common: &gateway-common
  build:
    context: .
    dockerfile: Dockerfile
  environment:
    RABBITMQ_URL: amqp://guest:guest@haproxy:5672
    RABBITMQ_MANAGEMENT_URL: http://haproxy:15672
    RABBITMQ_MANAGEMENT_USER: guest
    RABBITMQ_MANAGEMENT_PASSWORD: guest
    MONGO_URL: mongodb://mongo:27017/superqueues
    REDIS_URL: redis://redis:6379
    NODE_ENV: production
  depends_on:
    haproxy:
      condition: service_healthy
    mongo:
      condition: service_started
    redis:
      condition: service_started

services:
  # ─────────────────────────────────────────────────────────────────
  # RabbitMQ Cluster (3 nodes)
  # ─────────────────────────────────────────────────────────────────
  rabbit1:
    <<: *rabbitmq-common
    hostname: rabbit1
    container_name: sq-rabbit1
    environment:
      RABBITMQ_ERLANG_COOKIE: "superqueues-cluster-cookie"
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_NODENAME: rabbit@rabbit1
    volumes:
      - rabbit1_data:/var/lib/rabbitmq
      - ./cluster/rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
      - ./cluster/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    networks:
      - sq-cluster

  rabbit2:
    <<: *rabbitmq-common
    hostname: rabbit2
    container_name: sq-rabbit2
    environment:
      RABBITMQ_ERLANG_COOKIE: "superqueues-cluster-cookie"
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_NODENAME: rabbit@rabbit2
    volumes:
      - rabbit2_data:/var/lib/rabbitmq
      - ./cluster/rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
      - ./cluster/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    depends_on:
      rabbit1:
        condition: service_healthy
    networks:
      - sq-cluster

  rabbit3:
    <<: *rabbitmq-common
    hostname: rabbit3
    container_name: sq-rabbit3
    environment:
      RABBITMQ_ERLANG_COOKIE: "superqueues-cluster-cookie"
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_NODENAME: rabbit@rabbit3
    volumes:
      - rabbit3_data:/var/lib/rabbitmq
      - ./cluster/rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
      - ./cluster/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    depends_on:
      rabbit1:
        condition: service_healthy
    networks:
      - sq-cluster

  # ─────────────────────────────────────────────────────────────────
  # HAProxy - Load balancer for RabbitMQ
  # ─────────────────────────────────────────────────────────────────
  haproxy:
    image: haproxy:2.9-alpine
    container_name: sq-haproxy
    ports:
      - "5672:5672"     # AMQP
      - "15672:15672"   # Management UI
      - "1936:1936"     # HAProxy stats
    volumes:
      - ./cluster/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      rabbit1:
        condition: service_healthy
      rabbit2:
        condition: service_healthy
      rabbit3:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - sq-cluster

  # ─────────────────────────────────────────────────────────────────
  # Gateway instances (3 nodes)
  # ─────────────────────────────────────────────────────────────────
  gateway1:
    <<: *gateway-common
    container_name: sq-gateway1
    environment:
      RABBITMQ_URL: amqp://guest:guest@haproxy:5672
      RABBITMQ_MANAGEMENT_URL: http://haproxy:15672
      RABBITMQ_MANAGEMENT_USER: guest
      RABBITMQ_MANAGEMENT_PASSWORD: guest
      MONGO_URL: mongodb://mongo:27017/superqueues
      REDIS_URL: redis://redis:6379
      PORT: "3000"
      INSTANCE_ID: gateway1
    networks:
      - sq-cluster

  gateway2:
    <<: *gateway-common
    container_name: sq-gateway2
    environment:
      RABBITMQ_URL: amqp://guest:guest@haproxy:5672
      RABBITMQ_MANAGEMENT_URL: http://haproxy:15672
      RABBITMQ_MANAGEMENT_USER: guest
      RABBITMQ_MANAGEMENT_PASSWORD: guest
      MONGO_URL: mongodb://mongo:27017/superqueues
      REDIS_URL: redis://redis:6379
      PORT: "3000"
      INSTANCE_ID: gateway2
    networks:
      - sq-cluster

  gateway3:
    <<: *gateway-common
    container_name: sq-gateway3
    environment:
      RABBITMQ_URL: amqp://guest:guest@haproxy:5672
      RABBITMQ_MANAGEMENT_URL: http://haproxy:15672
      RABBITMQ_MANAGEMENT_USER: guest
      RABBITMQ_MANAGEMENT_PASSWORD: guest
      MONGO_URL: mongodb://mongo:27017/superqueues
      REDIS_URL: redis://redis:6379
      PORT: "3000"
      INSTANCE_ID: gateway3
    networks:
      - sq-cluster

  # ─────────────────────────────────────────────────────────────────
  # Nginx - Load balancer for Gateway
  # ─────────────────────────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: sq-nginx
    ports:
      - "3000:80"       # Gateway API
    volumes:
      - ./cluster/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - gateway1
      - gateway2
      - gateway3
    networks:
      - sq-cluster

  # ─────────────────────────────────────────────────────────────────
  # Shared Services
  # ─────────────────────────────────────────────────────────────────
  mongo:
    image: mongo:7
    container_name: sq-mongo
    volumes:
      - mongo_data:/data/db
    networks:
      - sq-cluster

  redis:
    image: redis:7-alpine
    container_name: sq-redis
    volumes:
      - redis_data:/data
    networks:
      - sq-cluster

networks:
  sq-cluster:
    driver: bridge

volumes:
  rabbit1_data:
  rabbit2_data:
  rabbit3_data:
  mongo_data:
  redis_data:
