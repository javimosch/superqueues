global
    log stdout format raw local0
    maxconn 4096

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5s
    timeout client  120s
    timeout server  120s
    retries 3

# HAProxy stats UI
listen stats
    bind *:1936
    mode http
    stats enable
    stats uri /
    stats refresh 5s
    stats show-legends
    stats admin if TRUE

# RabbitMQ AMQP load balancing
frontend rabbitmq_amqp
    bind *:5672
    default_backend rabbitmq_amqp_backend

backend rabbitmq_amqp_backend
    balance roundrobin
    option tcp-check
    server rabbit1 rabbit1:5672 check inter 5s rise 2 fall 3
    server rabbit2 rabbit2:5672 check inter 5s rise 2 fall 3
    server rabbit3 rabbit3:5672 check inter 5s rise 2 fall 3

# RabbitMQ Management UI/API load balancing
# Use TCP checks to avoid false negatives due to auth requirements on /api/*
frontend rabbitmq_management
    bind *:15672
    mode tcp
    default_backend rabbitmq_management_backend

backend rabbitmq_management_backend
    mode tcp
    balance roundrobin
    option tcp-check
    server rabbit1 rabbit1:15672 check inter 5s rise 2 fall 3
    server rabbit2 rabbit2:15672 check inter 5s rise 2 fall 3
    server rabbit3 rabbit3:15672 check inter 5s rise 2 fall 3
